clc
clear all
close all

a0 = [0.3159; 0.3157];

b0 = [0.000046911; 0.00083798];

a1 = [0.6104; 0.61; 0.6103; 0.6102; 0.6101; 0.6039; 0.6042; 0.6039; 0.6149; 0.6107; 0.6082];

b1 = [29.058; 0.007566; 0.0431; 0.5038; 0.007839; 0.015381; 0.01033; 0.5531; 0.002004; 0.0002555; 0.1373];

a2 = [1.1945; 1.1938; 1.1940; 1.1939; 1.1938; 1.1948; 1.1959; 1.1972; 1.203; 1.1941];

b2 = [11.71; 11.87; 0.0127; 0.0177; 0.013; 0.04931;  0.004921; 11.251; 0.03454; 0.009472];

a3 = [1.7911; 1.7897; 1.7857; 1.7917; 1.7758];

b3 = [0.1577; 0.0126; 0.0374; 0.1; 0.2188];

a4 = [2.378; 2.3765; 2.3836; 2.37];

b4 = [1.3618; 0.148; 0.21; 1.075];

##x = [a0; a1; a2 ;a3 ;a4];
##
##y = [b0; b1 ;b2 ;b3 ;b4];

% th = [116.84; -110.38; 0.024271; -18.647; -3.71]  % modelo var para Z com 2 exponenciais


c0 = [0.0121; 0.01206];
c0 = 0.312*ones(2,1);

d0 = [0.000017455; 0.00002765];

c1 = [0.0113; 0.0113; 0.0114; 0.0115; 0.0282; 0.0282; 0.02829; 0.0213; 0.01359; 0.00956];
c1 = 0.6*ones(10,1);

d1 = [0.0004772; 0.001218; 0.0949; 0.0005715; 0.000578; 0.0009698; 0.0828; 0.0009084; 0.00006151; 0.4533];

c2 = [0.0071; 0.0709; 0.0626; 0.06263; 0.062587; 0.0628; 0.02913; 0.00294; 0.0428; 0.0013];
c2 = 1.2*ones(10,1);

d2 = [0.7371; 0.7430; 0.001961; 0.00265; 0.0013885; 0.00571; 0.0002617; 0.9313; 1.126; 0.0006998];

c3 = [0.0511; 0.0502; 0.0508; 0.0229; 0.0178];
c3 = 1.8*ones(5,1);

d3 = [0.01239; 0.0001874; 0.001141; 0.1485; 0.2265];

c4 = [ 0.1312; 0.1042; 0.0226];
c4 = 2.4*ones(3,1);

d4 = [0.0009212; 0.028475; 0.0365];


x = [c0; c1; c2; c3; c4];
y = [d0; d1; d2; d3; d4];

alfa = 0.2;

hold on
plot(x,y)
p1 = plot(x,y, '*r');

th = 1*randn(4,1) - 0.5;

k = 0;
Dmax = 0.3;
do
  k++
% modelo = th(1) + th(2)*exp(th(3)*x) + th(4)*exp(th(5)*x) + th(6)*exp(th(7)*x);
##  modelo = th(1) + th(2)*exp(th(3)*x) + th(4)*exp(th(5)*x);
  modelo = (th(1) + th(2)*x.^1 + th(3)*x.^2 + th(4)*x.^3).^2;

%%  modelo = th(1)*exp(th(2)*x);

  set(p1,'Ydata',modelo);

  dy = y - modelo;

%%  derivada1 = exp(th(2)*x);
%%  derivada2 = th(1)*x.*exp(th(1)*x);
%%  derivada2 = x.*exp(th(2)*x);
%%  derivada3 = x.*exp(th(3)*x);

  derivada1 = 2*(th(1) + th(2)*x.^1 + th(3)*x.^2 + th(4)*x.^3).*x.^0;
  derivada2 = 2*(th(1) + th(2)*x.^1 + th(3)*x.^2 + th(4)*x.^3).*x.^1;
  derivada3 = 2*(th(1) + th(2)*x.^1 + th(3)*x.^2 + th(4)*x.^3).*x.^2;
  derivada4 = 2*(th(1) + th(2)*x.^1 + th(3)*x.^2 + th(4)*x.^3).*x.^3;

%%  derivada1 = exp(th(2)*x);
%%  derivada2 = th(1)*x.*exp(th(1)*x

##  derivada3 = exp(th(4)*x);
##  derivada4 = th(3)*x.*exp(th(4)*x);
##  derivada1 = x.^0;
##  derivada2 = exp(th(3)*x);3
##  derivada3 = th(2)*x.*exp(th(3)*ox);
##  derivada4 = exp(th(5)*x);
##  derivada5 = th(4)*x.*exp(th(5)*x);
##  derivada6 = exp(th(7)*x);
##  derivada7 = th(6)*x.*exp(th(7)*x);

  J = [derivada1 derivada2 derivada3 derivada4];
  dth = inv(J'*J)*J'*dy;

  dth = inv(J'*J + 0.1*eye(length(th)))*J'*dy;

  if (norm(dth) > Dmax)       % se a norma for maior que o limite
    teste = 0
    dth = Dmax*dth/norm(dth); % satura a norma
  end

  th = th + alfa*dth;
  sum(abs(dth))
until ( sum(abs(dth)) < 10^-20 )


